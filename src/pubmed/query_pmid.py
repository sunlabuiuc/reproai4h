import csv
from Bio import Entrez
import time
from datetime import datetime

def search_pubmed(query, max_results=100, email="johnwu3@illinois.edu"):
    Entrez.email = email  # Always tell NCBI who you are
    handle = Entrez.esearch(db="pubmed", 
                            sort="relevance", 
                            retmax=max_results,
                            retmode="xml", 
                            term=query)
    results = Entrez.read(handle)
    return results

def get_pmids(query, max_results=100):
    results = search_pubmed(query, max_results)
    pmids = set(results["IdList"])
    return pmids

def save_pmids_to_csv(pmids, filename):
    with open(filename, 'w', newline='') as csvfile:
        writer = csv.writer(csvfile)
        writer.writerow(['PMID'])  # Header
        for pmid in pmids:
            writer.writerow([pmid])

# esearch -db pubmed -query '("artificial intelligence"[MeSH Terms] OR "artificial intelligence"[All Fields] OR "AI"[All Fields] OR "machine learning"[MeSH Terms] OR "machine learning"[All Fields] OR "ML"[All Fields]) AND journal article[Publication Type] AND 2018:2023[pdat] AND pubmed pmc open access[filter]' | efetch -format xml

def query_pmids():
    # query_type = "amia"
    nSamples = 10000 # can only do up to 10k

    # query = ('("artificial intelligence"[MeSH Terms] OR "artificial intelligence"[All Fields] OR '
    #          '"AI"[All Fields] OR "machine learning"[MeSH Terms] OR '
    #          '"machine learning"[All Fields] OR "ML"[All Fields]) AND '
    #          'journal article[Publication Type] AND '
    #          '2018:2024[pdat] AND '
    #          'pubmed pmc open access[filter]')
    # '(machine learning OR deep learning OR artificial intelligence) AND (electronic health record or EHR or EMR or electronic medical record or healthcare) NOT (survey or review or perspective or commentary or viewpoint or editorial or letter to the editor or correspondence or guideline or position paper or consensus statement or systematic review or meta-analysis or case report or literature review or education)' Probably fine
    # query = ('((("machine learning"[MeSH Terms] OR ("machine"[All Fields] AND "learning"[All Fields]) OR "machine learning"[All Fields] OR ("deep learning"[MeSH Terms] OR ("deep"[All Fields] AND "learning"[All Fields]) OR "deep learning"[All Fields]) OR ("artificial intelligence"[MeSH Terms] OR ("artificial"[All Fields] AND "intelligence"[All Fields]) OR "artificial intelligence"[All Fields])) AND ("electronic health records"[MeSH Terms] OR ("electronic"[All Fields] AND "health"[All Fields] AND "records"[All Fields]) OR "electronic health records"[All Fields] OR ("electronic"[All Fields] AND "health"[All Fields] AND "record"[All Fields]) OR "electronic health record"[All Fields] OR ("ethics hum res"[Journal] OR "environ hist rev"[Journal] OR "ehr"[All Fields]) OR ("empir musicol rev"[Journal] OR "emr"[All Fields]) OR ("electronic health records"[MeSH Terms] OR ("electronic"[All Fields] AND "health"[All Fields] AND "records"[All Fields]) OR "electronic health records"[All Fields] OR ("electronic"[All Fields] AND "medical"[All Fields] AND "record"[All Fields]) OR "electronic medical record"[All Fields]) OR ("delivery of health care"[MeSH Terms] OR ("delivery"[All Fields] AND "health"[All Fields] AND "care"[All Fields]) OR "delivery of health care"[All Fields] OR "healthcare"[All Fields] OR "healthcare s"[All Fields] OR "healthcares"[All Fields]))) NOT ("survey s"[All Fields] OR "surveyed"[All Fields] OR "surveying"[All Fields] OR "surveys and questionnaires"[MeSH Terms] OR ("surveys"[All Fields] AND "questionnaires"[All Fields]) OR "surveys and questionnaires"[All Fields] OR "survey"[All Fields] OR "surveys"[All Fields] OR ("review"[Publication Type] OR "review literature as topic"[MeSH Terms] OR "review"[All Fields]) OR ("perspective"[All Fields] OR "perspective s"[All Fields] OR "perspectives"[All Fields]) OR ("comment"[Publication Type] OR "commentary"[All Fields]) OR ("comment"[Publication Type] OR "viewpoint"[All Fields]) OR ("editorial"[Publication Type] OR "editorial"[All Fields]) OR (("letter"[Publication Type] OR "correspondence as topic"[MeSH Terms] OR "letter"[All Fields]) AND to the[Author] AND ("editor"[All Fields] OR "editor s"[All Fields] OR "editors"[All Fields])) OR ("letter"[Publication Type] OR "correspondence as topic"[MeSH Terms] OR "correspondence"[All Fields]) OR ("guideline"[Publication Type] OR "guidelines as topic"[MeSH Terms] OR "guideline"[All Fields]) OR (("patient positioning"[MeSH Terms] OR ("patient"[All Fields] AND "positioning"[All Fields]) OR "patient positioning"[All Fields] OR "positioning"[All Fields] OR "position"[All Fields] OR "position s"[All Fields] OR "positional"[All Fields] OR "positioned"[All Fields] OR "positionings"[All Fields] OR "positions"[All Fields]) AND ("paper"[MeSH Terms] OR "paper"[All Fields] OR "papers"[All Fields] OR "paper s"[All Fields])) OR ("consens statement"[Journal] OR ("consensus"[All Fields] AND "statement"[All Fields]) OR "consensus statement"[All Fields]) OR ("systematic review"[Publication Type] OR "systematic reviews as topic"[MeSH Terms] OR "systematic review"[All Fields]) OR ("meta analysis"[Publication Type] OR "meta analysis as topic"[MeSH Terms] OR "meta analysis"[All Fields]) OR ("case reports"[Publication Type] OR "case report"[All Fields]) OR ("review"[Publication Type] OR "review literature as topic"[MeSH Terms] OR "literature review"[All Fields]) OR ("educability"[All Fields] OR "educable"[All Fields] OR "educates"[All Fields] OR "education"[MeSH Subheading] OR "education"[All Fields] OR "educational status"[MeSH Terms] OR ("educational"[All Fields] AND "status"[All Fields]) OR "educational status"[All Fields] OR "education"[MeSH Terms] OR "education s"[All Fields] OR "educational"[All Fields] OR "educative"[All Fields] OR "educator"[All Fields] OR "educator s"[All Fields] OR "educators"[All Fields] OR "teaching"[MeSH Terms] OR "teaching"[All Fields] OR "educate"[All Fields] OR "educated"[All Fields] OR "educating"[All Fields] OR "educations"[All Fields]))) AND ((ffrft[Filter]) AND (classicalarticle[Filter] OR clinicalstudy[Filter] OR clinicaltrial[Filter] OR clinicaltrialphasei[Filter] OR clinicaltrialphaseii[Filter] OR clinicaltrialphaseiii[Filter] OR clinicaltrialphaseiv[Filter] OR dataset[Filter] OR governmentpublication[Filter] OR preprint[Filter] OR randomizedcontrolledtrial[Filter] OR researchsupportamericanrecoveryandreinvestmentact[Filter] OR researchsupportnihextramural[Filter] OR researchsupportnihintramural[Filter] OR researchsupportnonusgovt[Filter] OR researchsupportusgovtnonphs[Filter] OR researchsupportusgovtphs[Filter] OR researchsupportusgovernment[Filter] OR technicalreport[Filter] OR validationstudy[Filter]))')
    
    # for scraping general journal papers
    query = '((("machine learning"[MeSH Terms] OR ("machine"[All Fields] AND "learning"[All Fields]) OR "machine learning"[All Fields] OR ("deep learning"[MeSH Terms] OR ("deep"[All Fields] AND "learning"[All Fields]) OR "deep learning"[All Fields]) OR ("artificial intelligence"[MeSH Terms] OR ("artificial"[All Fields] AND "intelligence"[All Fields]) OR "artificial intelligence"[All Fields])) AND ("electronic health records"[MeSH Terms] OR ("electronic"[All Fields] AND "health"[All Fields] AND "records"[All Fields]) OR "electronic health records"[All Fields] OR ("electronic"[All Fields] AND "health"[All Fields] AND "record"[All Fields]) OR "electronic health record"[All Fields] OR ("ethics hum res"[Journal] OR "environ hist rev"[Journal] OR "ehr"[All Fields]) OR ("empir musicol rev"[Journal] OR "emr"[All Fields]) OR ("electronic health records"[MeSH Terms] OR ("electronic"[All Fields] AND "health"[All Fields] AND "records"[All Fields]) OR "electronic health records"[All Fields] OR ("electronic"[All Fields] AND "medical"[All Fields] AND "record"[All Fields]) OR "electronic medical record"[All Fields]) OR ("delivery of health care"[MeSH Terms] OR ("delivery"[All Fields] AND "health"[All Fields] AND "care"[All Fields]) OR "delivery of health care"[All Fields] OR "healthcare"[All Fields] OR "healthcare s"[All Fields] OR "healthcares"[All Fields]))) NOT ("survey s"[All Fields] OR "surveyed"[All Fields] OR "surveying"[All Fields] OR "surveys and questionnaires"[MeSH Terms] OR ("surveys"[All Fields] AND "questionnaires"[All Fields]) OR "surveys and questionnaires"[All Fields] OR "survey"[All Fields] OR "surveys"[All Fields] OR ("review"[Publication Type] OR "review literature as topic"[MeSH Terms] OR "review"[All Fields]) OR ("perspective"[All Fields] OR "perspective s"[All Fields] OR "perspectives"[All Fields]) OR ("comment"[Publication Type] OR "commentary"[All Fields]) OR ("comment"[Publication Type] OR "viewpoint"[All Fields]) OR ("editorial"[Publication Type] OR "editorial"[All Fields]) OR (("letter"[Publication Type] OR "correspondence as topic"[MeSH Terms] OR "letter"[All Fields]) AND to the[Author] AND ("editor"[All Fields] OR "editor s"[All Fields] OR "editors"[All Fields])) OR ("letter"[Publication Type] OR "correspondence as topic"[MeSH Terms] OR "correspondence"[All Fields]) OR ("guideline"[Publication Type] OR "guidelines as topic"[MeSH Terms] OR "guideline"[All Fields]) OR (("patient positioning"[MeSH Terms] OR ("patient"[All Fields] AND "positioning"[All Fields]) OR "patient positioning"[All Fields] OR "positioning"[All Fields] OR "position"[All Fields] OR "position s"[All Fields] OR "positional"[All Fields] OR "positioned"[All Fields] OR "positionings"[All Fields] OR "positions"[All Fields]) AND ("paper"[MeSH Terms] OR "paper"[All Fields] OR "papers"[All Fields] OR "paper s"[All Fields])) OR ("consens statement"[Journal] OR ("consensus"[All Fields] AND "statement"[All Fields]) OR "consensus statement"[All Fields]) OR ("systematic review"[Publication Type] OR "systematic reviews as topic"[MeSH Terms] OR "systematic review"[All Fields]) OR ("meta analysis"[Publication Type] OR "meta analysis as topic"[MeSH Terms] OR "meta analysis"[All Fields]) OR ("case reports"[Publication Type] OR "case report"[All Fields]) OR ("review"[Publication Type] OR "review literature as topic"[MeSH Terms] OR "literature review"[All Fields]) OR ("educability"[All Fields] OR "educable"[All Fields] OR "educates"[All Fields] OR "education"[MeSH Subheading] OR "education"[All Fields] OR "educational status"[MeSH Terms] OR ("educational"[All Fields] AND "status"[All Fields]) OR "educational status"[All Fields] OR "education"[MeSH Terms] OR "education s"[All Fields] OR "educational"[All Fields] OR "educative"[All Fields] OR "educator"[All Fields] OR "educator s"[All Fields] OR "educators"[All Fields] OR "teaching"[MeSH Terms] OR "teaching"[All Fields] OR "educate"[All Fields] OR "educated"[All Fields] OR "educating"[All Fields] OR "educations"[All Fields]))) AND ((ffrft[Filter]) AND (classicalarticle[Filter] OR clinicalstudy[Filter] OR clinicaltrial[Filter] OR clinicaltrialphasei[Filter] OR clinicaltrialphaseii[Filter] OR clinicaltrialphaseiii[Filter] OR clinicaltrialphaseiv[Filter] OR dataset[Filter] OR governmentpublication[Filter] OR preprint[Filter] OR randomizedcontrolledtrial[Filter] OR researchsupportamericanrecoveryandreinvestmentact[Filter] OR researchsupportnihextramural[Filter] OR researchsupportnihintramural[Filter] OR researchsupportnonusgovt[Filter] OR researchsupportusgovtnonphs[Filter] OR researchsupportusgovtphs[Filter] OR researchsupportusgovernment[Filter] OR technicalreport[Filter] OR validationstudy[Filter])) AND pubmed pmc open access[filter]'
    filename = f"data/raw/pubmed/open_access_ai_ml_pmids.csv"

    pmids = get_pmids(query, max_results = nSamples)
    
    save_pmids_to_csv(pmids, filename)
    
    print(f"Total unique open access PMIDs found: {len(pmids)}")
    print(f"PMIDs have been saved to {filename}")
    return pmids, filename

if __name__ == "__main__":
    query_pmids()


#Filters applied: Free full text, Classical Article, Clinical Study, Clinical Trial, Clinical Trial, Phase I, Clinical Trial, Phase II, Clinical Trial, Phase III, Clinical Trial, Phase IV, Dataset, Government Publication, Preprint, Randomized Controlled Trial, Randomized Controlled Trial, Veterinary, Research Support, American Recovery and Reinvestment Act, Research Support, N.I.H., Extramural, Research Support, N.I.H., Intramural, Research Support, Non-U.S. Gov't, Research Support, U.S. Gov't, Non-P.H.S., Research Support, U.S. Gov't, P.H.S., Research Support, U.S. Gov't, Technical Report, Validation Study. Open PMC Access
#'(machine learning OR deep learning OR artificial intelligence) AND (electronic health record or EHR or EMR or electronic medical record or healthcare) NOT (survey or review or perspective or commentary or viewpoint or editorial or letter to the editor or correspondence or guideline or position paper or consensus statement or systematic review or meta-analysis or case report or literature review or education)'